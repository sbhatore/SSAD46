<!DOCTYPE html>
<html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>SCFT</title>

<link rel="shortcut icon" href="http://www.hongkiat.com/blog/favicon.ico">
<link rel="icon" href="http://www.hongkiat.com/blog/favicon.ico">
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>


<%= stylesheet_link_tag "demo.css" %>

<link rel="stylesheet" type="text/css" media="all" href="http://fonts.googleapis.com/css?family=ABeeZee">
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){
  $("#srch").on("click", function(e){
    e.preventDefault();
    var hrefval = $(this).attr("href");
    
    if(hrefval == "#about") {
      var distance = $('#mainpage').css('left');
      
      if(distance == "auto" || distance == "0px") {
        $(this).addClass("open");
        openSidepage();
      } else {
        closeSidepage();
      }
    }
  }); // end click event handler
  
  $("#srch").on("hover", function(){
    var classval = $(this).hasClass("hovertrigger");
    
    if(classval == true) {
      var distance = $('#mainpage').css('left');
      
      if(distance == "auto" || distance == "0px") {
        $(this).addClass("open");
        openSidepage();
      }
    }
  }); // end hover event handler
  
  $("#closebtn").on("click", function(e){
    e.preventDefault();
    closeSidepage();
  }); // end close button event handler

  function openSidepage() {
    $('#mainpage').animate({
      left: '350px'
    }, 400, 'easeOutBack'); 
  }
  
  function closeSidepage(){
    $("#srchd").removeClass("open");
    $('#mainpage').animate({
      left: '0px'
    }, 400, 'easeOutQuint');  
  }
}); 
</script>

 <script>
            // In the following example, markers appear when the user clicks on the map.
            // The markers are stored in an array.
            // The user can then click an option to hide, show or delete the markers.
            var map;
            var geocoder;
            var markers = [];


            function initialize() {
                geocoder = new google.maps.Geocoder();
                var centre = new google.maps.LatLng("<%=$ilatitude_mycity%>", "<%=$ilongitude_mycity %>");
                var mapOptions = {
                    zoom: 5,
                    center: centre,
                    mapTypeId: google.maps.MapTypeId.HYBRID
                };
                map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

                var len = document.getElementById('length').innerHTML;


                marker = new google.maps.Marker({
                    icon:"http://maps.google.com/mapfiles/ms/icons/green-dot.png",
                    position: centre,
                    map: map
                });
                var infowindow = new google.maps.InfoWindow({
                      content:  '<b>' + "<%=$icityname%>" + '</b>' + '<br/>' + 
                      'latitude : ' + "<%=$ilatitude_mycity%>"+
                      '<br/>' + 'longitude :  ' +
                      "<%=$ilongitude_mycity%>"
                      });

                infowindow.open(map,marker);
                                
                codeAddress();
                lat_belt();
                draw_radius();
            }
            var marker;
            var parliament;
            var j;
            var i;
            var flag;

            function codeAddress() {
                    var lat = document.getElementById('searchpanel').getElementsByClassName("lat");
                    console.log(lat);
                    var lon = document.getElementById('searchpanel').getElementsByClassName("lon");
                    var len = document.getElementById('length').innerHTML; //Number of cities
                    console.log(len);
                    //if(len > 10)
                      //  len=10;
                    for(i=0;i<len;i++){
                        console.log(lat[i].innerHTML);
                        var loc = new google.maps.LatLng(lat[i].innerHTML,lon[i].innerHTML);
                        
                        
                        markers.push(new google.maps.Marker({
                            //   position: location,
                            icon:{url : '/assets/marker.png'},
                            position: loc,
                            map: map,
                            
                         }));
                        
                        console.log(markers);
                          google.maps.event.addListener(markers[i],'click',function() {
                          map.setZoom(9);
                          console.log(markers[i].getPosition());
                          map.setCenter(markers[i].getPosition());
                          });


                    }               
                }
                //onmouseover implementation
            function gc(element) {
                geocoder.geocode({
                        'address': element.innerHTML
                    },
                    function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {

                            // Clear the previous marker
                            if (marker) marker.setMap(null);

                            // Set the new marker
                            marker = new google.maps.Marker({
                                position: results[0].geometry.location,
                                map: map,
                                

                            });
                            

                              

                              map.setCenter(results[0].geometry.location);
                             map.setZoom(9);

                             google.maps.event.trigger(marker, 'click');

                          //  zoom_on_click(marker, address);
                            

                            // Center the map on the geocoded result
                           
                        }
                    });
            }

            //make latitude belt
            function lat_belt() {
                
                var ran = parseFloat(document.getElementById('ran').innerHTML);
                console.log("ran: " + ran);
                   
                    var lat = parseFloat("<%=$ilatitude_mycity%>");

                    var lon =parseFloat("<%=$ilongitude_mycity%>");


                    var l_up = new google.maps.LatLng(lat + ran, -177);
                    var m_up = new google.maps.LatLng(lat + ran, 0);
                    var r_up = new google.maps.LatLng(lat + ran, +177);
                    var l_down = new google.maps.LatLng(lat - ran, +177);
                    var m_down = new google.maps.LatLng(lat - ran, 0);
                    var r_down = new google.maps.LatLng(lat - ran, -177);

                    var myTrip = [l_up, m_up, r_up, l_down, m_down, r_down];



                    var flightPath = new google.maps.Polygon({
                        path: myTrip,
                        strokeColor: "#000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#0000FF",
                        fillOpacity: 0.4
                    });

                    flightPath.setMap(map);

                }

            //Radius range implementation and infowindow showing entered city.

            function draw_radius() {
                var address = "<%=$icityname %>";
                var rad = parseFloat(document.getElementById('radius').innerHTML);
                rad = rad * 1000;
                console.log(rad);
                console.log(address);
               
               
                 var lat = parseFloat("<%=$ilatitude_mycity%>");
                 console.log("check"+lat);   
                 var lon =parseFloat("<%=$ilongitude_mycity%>");


                var city = new google.maps.LatLng(lat, lon);

                var myCity = new google.maps.Circle({
                    center: city,
                    radius: rad,
                    strokeColor: "#000",
                    strokeOpacity: 0.2,
                    strokeWeight: 2,
                    fillColor: "#fff",
                    fillOpacity: 0.4
                });

                //console.log(myCity);

                myCity.setMap(map);
            }

          

            function zoom_on_click(marker, address) {
                google.maps.event.addListener(marker, 'click', function() {
                    map.setZoom(9);
                    map.setCenter(marker.getPosition());
                    var infowindow = new google.maps.InfoWindow({
                        content: address
                    });
                    infowindow.open(map, marker);
                });
            }

            // Add a marker to the map and push to the array.
            function addMarker(location) {
                var image = {
                    src: '<i class="fa fa-map-marker"></i>',
                    size: new google.maps.Size(24, 24), 
                    origin: new google.maps.Point(0,0),   
                    anchor: new google.maps.Point(12,12)
                };
                
                marker = new google.maps.Marker({
                    //   position: location,
                    icon:image,
                    position: location,
                    map: map,
                    
                });
                console.log(marker); 
            }




            // Sets the map on all markers in the array.


            function setAllMap(map) {
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(map);
                }
            }

            // Removes the markers from the map, but keeps them in the array.


            function clearMarkers() {
                setAllMap(null);
            }

            // Shows any markers currently in the array.


            function showMarkers() {
                setAllMap(map);
            }

            // Deletes all markers in the array by removing references to them.


            function deleteMarkers() {
                clearMarkers();
                markers = [];
            }

            //calcu();
            google.maps.event.addDomListener(window, 'load', initialize);
       
 
        <!--CODE FOR RMS-->





       

function calcu()
{
    tt= document.getElementById('searchpanel').getElementsByTagName("span");
    climatedata=gowiki('<%= $icityname %>');
    drawmainmap('<%= $ilatitude_mycity %>','<%= $ilatitude_mycity %>',tt,climatedata);

}

function drawtable(tabledata)
{   count=count+1;
    var i=0;
    var maindata="<table id=\"myTable"+count+"\" class=\"tablesorter\"><thead> <tr><th>City Name</th><th>Country Name</th><th>RMS MAX</th><th>RMS Min</th><th>RMS Total</th></tr></thead><tbody>";
    while(i<tabledata.length)
    {
        var template="<tr><td>"+tabledata[i][0]+"</td><td>"+tabledata[i][1]+"</td><td>"+tabledata[i][2]+"</td><td>"+tabledata[i][3]+"</td><td>"+tabledata[i][4]+"</td></tr>";
        maindata=maindata+template;
        i=i+1;
    }
    document.getElementById("tablespace").innerHTML=maindata+"</tbody></table>";
    
    $("#myTable"+count).tablesorter(); 
}


function distance(lat1, lon1, lat2, lon2, unit) {

    var radlat1 = Math.PI * lat1/180;

    var radlat2 = Math.PI * lat2/180;

    var radlon1 = Math.PI * lon1/180;

    var radlon2 = Math.PI * lon2/180;

    var theta = lon1-lon2;

    var radtheta = Math.PI * theta/180;

    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);

    dist = Math.acos(dist);

    dist = dist * 180/Math.PI;

    dist = dist * 60 * 1.1515;

    if (unit=="K") { dist = dist * 1.609344; }

    if (unit=="N") { dist = dist * 0.8684; }

    return dist;

}



function drawmainmap(lat,lng,matter,citydata)
{   
    var lnrange = parseFloat('<%= $ilatitude_range %>');//parseFloat(document.getElementById("latrange").value);
    var maxtemp = parseFloat(40);//parseFloat(document.getElementById("maxtemp").value);
    var mintemp = parseFloat(20);//parseFloat(document.getElementById("mintemp").value);
    var rad = parseFloat('<%= $iradius_range %>');//parseFloat(document.getElementById("radrange").value);
   // var myCenter=new google.maps.LatLng(lat,lng);
    var cmf=0;
    if(citydata.length==0)
    {
        cmf=1;
    }
   /* var mapProp = {
          center:myCenter,
          zoom:7,
          mapTypeId:google.maps.MapTypeId.HYBRID,
          
        
     };

    var map=new google.maps.Map(document.getElementById("chart_div2"),mapProp);

    var marker=new google.maps.Marker({
          position:myCenter,
icon:'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
      });
    marker.setMap(map);
    var circle = new google.maps.Circle({
                center: myCenter,
                map:map,
                radius:rad*1000,
                strokeColor: "black",
                strokeOpacity:0.4,
                strokeWeight: 2,
                fillColor: "black"
            });
            circle.bindTo('center',marker,'position');
   */ i=0;
    var tabledata=[];
    while(i<matter.length)
    {
        var fl=1;
        //var myCenter=new google.maps.LatLng(matter[i].latitude,matter[i].longitude);
        //var marker=new google.maps.Marker({
          //position:myCenter,});
        
        var the=[];
        the.push([matter[i].mjan,matter[i].njan]);
        the.push([matter[i].mfeb,matter[i].nfeb]);
        the.push([matter[i].mmar,matter[i].nmar]);
        the.push([matter[i].mapr,matter[i].napr]);
        the.push([matter[i].mmay,matter[i].nmay]);
        the.push([matter[i].mjun,matter[i].njun]);
        the.push([matter[i].mjul,matter[i].njul]);
        the.push([matter[i].maug,matter[i].naug]);
        the.push([matter[i].msep,matter[i].nsep]);
        the.push([matter[i].moct,matter[i].noct]);
        the.push([matter[i].mnov,matter[i].nnov]);
        the.push([matter[i].mdec,matter[i].ndec]);
        if(cmf==1)
        {
            citydata=[];    
            citydata.push([matter[i].mjan,matter[i].njan]);
            citydata.push([matter[i].mfeb,matter[i].nfeb]);
            citydata.push([matter[i].mmar,matter[i].nmar]);
            citydata.push([matter[i].mapr,matter[i].napr]);
            citydata.push([matter[i].mmay,matter[i].nmay]);
            citydata.push([matter[i].mjun,matter[i].njun]);
            citydata.push([matter[i].mjul,matter[i].njul]);
            citydata.push([matter[i].maug,matter[i].naug]);
            citydata.push([matter[i].msep,matter[i].nsep]);
            citydata.push([matter[i].moct,matter[i].noct]);
            citydata.push([matter[i].mnov,matter[i].nnov]);
            citydata.push([matter[i].mdec,matter[i].ndec]);
        }
        
        var arr=[];
        var kk=0;
        var rmsmax=[];
        var rmsmin=[];
        var rmstotal=[];

        var ll=distance(lat,lng,parseFloat(matter[i].latitude),parseFloat(matter[i].longitude),"K");
        
        
        while(kk<12)
        {
            if(Math.abs(parseFloat(the[kk][0])-parseFloat(citydata[kk][0]))<=maxtemp )

            {
                arr.push(1);
            }
            else
            {
                //alert([the[kk][0],citydata[kk][0]]);
                arr.push(0);
                fl=0;
            }
            rmsmax.push(Math.pow(Math.abs(parseFloat(the[kk][0])-parseFloat(citydata[kk][0])),2 ));
            rmsmin.push(Math.pow(Math.abs(parseFloat(the[kk][1])-parseFloat(citydata[kk][1])),2 ));
            rmstotal.push(Math.pow(Math.abs(parseFloat(the[kk][0])-parseFloat(citydata[kk][0])),2));
            rmstotal.push(Math.pow(Math.abs(parseFloat(the[kk][1])-parseFloat(citydata[kk][1])),2));
            kk=kk+1;
        }
        kk=0;
        rmax=0;
        rmin=0;
        rtotal=0;
        while(kk<12)
        {
            rmax=rmax+rmsmax[kk];
            rmin=rmin+rmsmin[kk];
            rtotal=rtotal+rmstotal[2*kk];
            rtotal=rtotal+rmstotal[2*kk+1];
            kk=kk+1;
        }
        rmax=Math.sqrt(rmax/12);
        rmin=Math.sqrt(rmin/12);
        rtotal=Math.sqrt(rtotal/24);
        rmax=Math.round(rmax * 100) / 100;
        rmin=Math.round(rmin * 100) / 100;
        rtotal=Math.round(rtotal * 100) / 100;
        
        if(fl==1 && ll<=rad)
        {
 //           marker.setMap(map);
            if(cmf==0)
            {
                tabledata.push([matter[i].cityname,matter[i].countryname,rmax,rmin,rtotal]);
            }
            else
            {
                tabledata.push([matter[i].cityname,matter[i].countryname,"N/A","N/A","N/A"]);
            }
    /*        var infowindow =  new google.maps.InfoWindow({content: '', 
            maxWidth: 200 });
            bindInfoWindow(marker, map, infowindow, "<p style=\" width:100px;color:black;font-width:bold\">" + matter[i].cityname + "</p>"); 
    */    }
        i=i+1;
    }
   /* var flightPlanCoordinates = [
    new google.maps.LatLng(lat+lnrange, -179),
    new google.maps.LatLng(lat+lnrange, 0.0),
    new google.maps.LatLng(lat+lnrange, 179.027892)
    ];
    var flightPath = new google.maps.Polyline({
    path: flightPlanCoordinates,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 1
    });

    flightPath.setMap(map);


    var flightPlanCoordinates = [
    new google.maps.LatLng(lat-lnrange, -179),
    new google.maps.LatLng(lat-lnrange, 0.0),
    new google.maps.LatLng(lat-lnrange, 179.027892)
    ];
    var flightPath = new google.maps.Polyline({
    path: flightPlanCoordinates,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 1
    });

    flightPath.setMap(map);
    drawtable(tabledata);
*/
}




function gowiki(cityname)
{
    
    var stt=cityname;//document.getElementById("city").innerHTML;
    var value=stt.toLowerCase();
    var postData = new Array();
    postData.push({name: 'cityname', value: value});
   var sendarray=[];
    
/*$.ajax({url : "http://localhost/submit1.php",type: "POST",data : postData,async: false,success:function(data, textStatus, jqXHR) 
{ */      var maxtemp=[];
        var mintemp=[];
        var maxyearavg;
        var minyearavg;
        if(data.length>1)
        {
            var i=0;
            while(i<data.length)
            {
                if(i<12)
                {   
                    maxtemp.push(data[i].substring(1,data[i].length-1));
                }
                else if(i==12)
                {
                     maxyearavg=data[i].substring(1,data[i].length-1);
                }
                else if(i<25)
                {
                    mintemp.push(data[i].substring(1,data[i].length-1));
                }
                else
                {
                    minyearavg=data[i].substring(1,data[i].length-1);
                }
                
                i=i+1;
            }
            i=0;
            var newdata=[["year","Min","Max"]];
            var dates=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            
            while(i<12)
            {
                var temp=[dates[i],parseFloat(mintemp[i]),parseFloat(maxtemp[i])];
                var temp1=[parseFloat(maxtemp[i]),parseFloat(mintemp[i])]   
                newdata.push(temp);
                sendarray.push(temp1);
                        
                i=i+1;  
            }
           // drawChart1(newdata); 
          //  document.getElementById("temp").innerHTML=maxyearavg + "&deg;C / " +minyearavg + "&deg;C";
            }
            else
            {
                sendarray=[];
                var newdata=[["year","Min","Max"]];
                var dates=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
                var i=0;
                while(i<12)
                {
                        newdata.push([dates[i],0,0]);
                        i=i+1;
                }
             //   drawChart1(newdata); 
            //    document.getElementById("temp").innerHTML="Weather Data Not Available";
         }
            /* }});*/
        return sendarray;
}


        </script>
<style>
p {
  font-size: 10; color: white;
}
p.pos_fixed{
      text-align: right;
      margin-right: :20px;
      position: relative;
      
}
</style>
</head>




<body>
<div id="about">
  <b><h2 style="background-color: transparent;">Modify Search</h2></b>
    
        <%= form_tag("/search", method: "get", remote: true) do %>
        <ul>
            <%= hidden_field_tag('city',$icityname) %><br>
            <li>
            <%= label_tag(:latitude_range, "Latitude Range*(in degrees)") %><br>
    <%= text_field_tag(:latitude_range,$ilatitude_range ) %><br>
          </li>

          <li>
           <%= label_tag(:elevation_range, "Elevation Range*(in m):") %><br>
    <%= text_field_tag(:elevation_range,$ielevation_range) %><br>
          </li>

           <li>
             <%= label_tag(:radius_range, "Radius Range(in km):") %><br>
    <%= text_field_tag(:radius_range,$iradius_range) %><br>
          </li>
          
           <%= hidden_field_tag 'latitude_mycity', $ilatitude_mycity %>
          
           <%= hidden_field_tag 'longitude_mycity', $ilongitude_mycity %>
          
            
         

          
             <%=  submit_tag("Search")%>

          
        
        </ul>
        <%end%>
        <a href="#" id="closebtn" class="close">Close Me</a>
 
        
</div>
<div id="mainpage">
    <p class="pos_fixed">Logged in as <%= current_user.email %></p>
    <nav id = "top" class="navbar navbar-default" style="margin-top:0">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#">SCFT</a>
      </div>
    <ul id="navigation" class="nav navbar-nav">
    <li><a href="#about" id="srch"><i class="glyphicon glyphicon-search" style="height:40px;width:40px;"></i></a></li>
      
      <li><a href="/welcome">Home</a></li>
      
      
      <li><a href="http://127.0.0.1:3000/log_out">Logout</a></li>
      
    </ul>
    </div>

    </nav>
  
  <div id="content"> 
    <h4 id="exist" style="float:right;margin-right:20px;margin-top:0px">Weather file of <b> <%=@city.titlecase%> </b>
    <%
    if(($found == 1))%>
        <i>exists</i>
    <%else%>
        <i>does not exist</i>
    <%end%>

    </h4>
    <div id="searchpanel" style="overflow-y: auto;height: 580px;margin-top:0px;margin-right:50px;border:2px solid;border-radius:10px;">
        <ul>

            Surrogate cities for
            <p id="city">
                <%=@city %>
            </p>
            Latitude range
            <p id="ran">
                <%=@lat_range %>
            </p>
            Elevation range
            <p id="ran">
                <%=@elev_range %>
            </p>
            Radius range(in Km)
            <p id="radius">
                <%=@rad_range%>
            </p>

            Total cities
            <p id="length">
                <%=@results.length%>
            </p>:
            <% @results.each do |c| %>
                <li style="display:none;">
                    <span id="hidden" href="#" onclick="gc(this);">
                        <%=c.city %>
                    </a>
                </li>
                <li class = "lat"style="display:none">
                    <%= c.latitude %>                    
                </li>
                <li class = "lon"style="display:none">
                    <%= c.longitude %>                    
                </li>
                <% end%>
                
        </ul>
    </div>
    <!-- place your main page content here --> 
    <div id="map-canvas">
    </div>
    <div id="display">
    </div>
    <div id="tablespace">
    </div>
  </div>
</div>

</body>
</html>